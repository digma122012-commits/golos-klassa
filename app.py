import os
import sqlite3
import base64
import re
import requests
from flask import Flask, request, redirect, render_template_string, send_file, jsonify
import tempfile

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
app = Flask(__name__)
app.secret_key = os.environ.get("SECRET_KEY", "render-secret-key-for-school")

DB_PATH = 'ideas.db'
ADMIN_PASSWORD = os.environ.get("ADMIN_PASSWORD", "school123")
MAX_IMAGE_SIZE = 2 * 1024 * 1024  # 2 MB

# --- –°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Å–ª–æ–≤ ---
BAD_WORDS = {
    '–±–ª—è', '–±–ª—è–¥', '–µ–±', '—ë–±', '—Ö—É–π', '–ø–∏–∑–¥', '—Å—É–∫–∞', '—Å—É—á', '–Ω–∞—Ö—É–π', '–Ω–∞—Ö–µ—Ä', '–æ—Ö—É–µ–ª', '–æ—Ö—É–µ–≤', '–∞—Ö—É–µ—Ç—å',
    '–≥–∞–Ω–¥–æ–Ω', '–≥–æ–≤–Ω–æ', '–¥—Ä–æ—á', '–µ–±–∞–ª', '–µ–±–∞–Ω', '–µ–±–∞—à', '–∑–∞–ª—É–ø', '–º—É–¥–∏–ª', '–º—É–¥–æ–∑', '–ø–∏–¥–æ—Ä', '–ø–µ–¥–∏–∫', '–ø–∏–¥–∞—Ä',
    '—Å—Ä–∞—Ç—å', '—Å—Å–∞—Ç—å', '—Ç—Ä–∞—Ö', '—á–º–æ', '—à–ª—é—Ö', '—à–∞–ª–∞–≤', '—É—Ä–æ–¥', '—Å–∫–æ—Ç–∏–Ω–∞', '–º–µ—Ä–∑–∞–≤–µ—Ü', '–≥–∞–¥', '—Å–≤–æ–ª–æ—á—å',
    '–ø–æ—Ä–Ω–æ', '—Å–µ–∫—Å', '–∏–Ω—Ç–∏–º', '—ç—Ä–æ—Ç–∏–∫', '–≥–æ–ª—ã–π', '–æ–±–Ω–∞–∂', '–Ω—é–¥', 'nude', 'porn', 'xxx', 'sex', 'boobs', 'dick',
    '–∂–µ—Å—Ç–æ–∫–æ', '—É–±–∏—Ç—å', '—Å–º–µ—Ä—Ç—å', '–ø–æ–≤–µ—Å–∏—Ç—å—Å—è', '—Å—É–∏—Ü–∏–¥', '–Ω–∞—Ä–∫–æ—Ç–∏–∫', '–º–∞—Ä–∏—Ö—É–∞–Ω', '–∞–º—Ñ–µ—Ç–∞–º–∏–Ω', '–∫–æ–∫–∞–∏–Ω',
    '–æ—Ä—É–∂–∏–µ', '–±–æ–º–±–∞', '–≤–∑–æ—Ä–≤–∞—Ç—å', '—Ç–µ—Ä—Ä–æ—Ä', '–∫—Ä–æ–≤—å', '—Ä–µ–∑–∞—Ç—å', '–Ω–æ–∂', '–ø–∏—Å—Ç–æ–ª–µ—Ç', '–Ω–∞—Å–∏–ª—å', '–∏–∑–Ω–∞—Å–∏–ª'
}

def contains_bad_words(text):
    if not text:
        return False
    clean = re.sub(r'[^–∞-—èa-z\s]', '', text.lower())
    words = clean.split()
    for word in words:
        for bad in BAD_WORDS:
            if bad in word:
                return True
    return False

def get_real_ip():
    """–ù–∞–¥—ë–∂–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ Render"""
    if request.headers.getlist("X-Forwarded-For"):
        ip = request.headers.get("X-Forwarded-For").split(",")[0].strip()
    else:
        ip = request.remote_addr or '127.0.0.1'
    return ip

def get_location_by_ip(ip):
    if ip in ('127.0.0.1', 'localhost', '::1'):
        return "–õ–æ–∫–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç"
    try:
        response = requests.get(f"https://ipapi.co/{ip}/json/", timeout=2)
        if response.status_code == 200:
            data = response.json()
            city = data.get("city") or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            region = data.get("region") or ""
            org = data.get("org") or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            return f"{city} ({region}), {org}"
    except:
        pass
    return "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å"

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î ---
def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS ideas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            text TEXT NOT NULL,
            ip TEXT NOT NULL,
            image_data TEXT,
            votes INTEGER DEFAULT 0,
            reply TEXT,  -- –æ—Ç–≤–µ—Ç –æ—Ç –∞–¥–º–∏–Ω–∞
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    c.execute('''
        CREATE TABLE IF NOT EXISTS votes (
            idea_id INTEGER,
            ip TEXT,
            PRIMARY KEY (idea_id, ip)
        )
    ''')
    conn.commit()
    conn.close()

# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
def process_image(file):
    if not file or not file.filename:
        return None
    ext = file.filename.lower().split('.')[-1]
    if ext not in {'png', 'jpg', 'jpeg', 'gif', 'webp'}:
        return None
    file.seek(0, os.SEEK_END)
    size = file.tell()
    file.seek(0)
    if size > MAX_IMAGE_SIZE:
        return None
    try:
        data = file.read()
        b64 = base64.b64encode(data).decode('utf-8')
        mime = 'image/jpeg' if ext in {'jpg', 'jpeg'} else \
               'image/png' if ext == 'png' else \
               'image/gif' if ext == 'gif' else 'image/webp'
        return f"{mime};base64,{b64}"
    except:
        return None

# --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ---
@app.route('/download/<int:idea_id>')
def download_image(idea_id):
    password = request.args.get('password')
    if password != ADMIN_PASSWORD:
        return "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", 403

    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    idea = conn.execute("SELECT image_data FROM ideas WHERE id = ?", (idea_id,)).fetchone()
    conn.close()

    if not idea or not idea['image_data']:
        return "–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", 404

    try:
        header, b64data = idea['image_data'].split(',', 1)
        mime = header.split(';')[0]
        ext = mime.split('/')[1] if '/' in mime else 'jpg'
        filename = f"idea_{idea_id}.{ext}"

        with tempfile.NamedTemporaryFile(delete=False, suffix=f".{ext}") as tmp:
            tmp.write(base64.b64decode(b64data))
            return send_file(tmp.name, as_attachment=True, download_name=filename)
    except Exception as e:
        return f"–û—à–∏–±–∫–∞: {e}", 500

# --- HTML: –≥–ª–∞–≤–Ω–∞—è ---
def get_index_html(ideas):
    ideas_html = ""
    for idea in ideas:
        img = f'<img src="{idea["image_data"]}" class="idea-img">' if idea["image_data"] else ""
        reply = f'<div class="reply">üí¨ –û—Ç–≤–µ—Ç: {idea["reply"]}</div>' if idea["reply"] else ""
        ideas_html += f'''
        <div class="idea">
            {img}
            <p>{idea["text"]}</p>
            {reply}
            <div class="meta">
                <span>–ì–æ–ª–æ—Å–æ–≤: {idea["votes"]}</span>
                <a href="/vote/{idea["id"]}">‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å</a>
            </div>
        </div>
        '''
    return f'''
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>–ì–æ–ª–æ—Å –∫–ª–∞—Å—Å–∞</title>
        <style>
            * {{ box-sizing: border-box; }}
            body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; margin: 0; padding: 16px; color: #333; }}
            .container {{ max-width: 700px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }}
            h1 {{ color: #2c3e50; text-align: center; margin-top: 0; }}
            textarea {{ width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; min-height: 80px; }}
            button {{ background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px; }}
            input[type="file"] {{ margin: 10px 0; width: 100%; }}
            .idea {{ background: #f8f9fa; padding: 16px; margin: 16px 0; border-radius: 10px; border-left: 4px solid #3498db; }}
            .idea-img {{ max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 10px; display: block; }}
            .reply {{ background: #e8f4fc; padding: 8px; border-radius: 6px; margin: 10px 0; font-style: italic; color: #2980b9; }}
            .meta {{ display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; font-size: 14px; color: #666; }}
            .meta a {{ color: #27ae60; text-decoration: none; font-weight: bold; }}
            .footer {{ margin-top: 30px; font-size: 12px; color: #777; text-align: center; }}
            .footer a {{ color: #777; text-decoration: underline; }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üó£Ô∏è –ì–æ–ª–æ—Å –∫–ª–∞—Å—Å–∞</h1>
            <p>–ê–Ω–æ–Ω–∏–º–Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∏–¥–µ–∏ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–π —Ñ–æ—Ç–æ! –ó–∞–ø—Ä–µ—â–µ–Ω—ã: –º–∞—Ç, 18+, –∞–≥—Ä–µ—Å—Å–∏—è.</p>
            <form method="POST" action="/add" enctype="multipart/form-data">
                <textarea name="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ—é –∏–¥–µ—é (–¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)..." maxlength="200" required></textarea>
                <input type="file" name="image" accept="image/*">
                <button type="submit">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–¥–µ—é</button>
            </form>
            <hr>
            <h2>–ò–¥–µ–∏ (–ø–æ –≥–æ–ª–æ—Å–∞–º)</h2>
            {ideas_html if ideas_html else "<p>–ü–æ–∫–∞ –Ω–µ—Ç –∏–¥–µ–π. –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</p>"}
            <div class="footer">
                <a href="/privacy">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
            </div>
        </div>
    </body>
    </html>
    '''

# --- HTML: –∞–¥–º–∏–Ω–∫–∞ ---
def get_admin_html(ideas, password):
    ideas_html = ""
    for idea in ideas:
        img = f'<img src="{idea["image_data"]}" class="admin-img">' if idea["image_data"] else "<span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>"
        location = get_location_by_ip(idea["ip"])
        download_link = f' | <a href="/download/{idea["id"]}?password={password}">üíæ –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ</a>' if idea["image_data"] else ""
        reply_input = f'''
        <form method="POST" action="/admin/reply" style="margin-top:8px;">
            <input type="hidden" name="idea_id" value="{idea["id"]}">
            <input type="hidden" name="password" value="{password}">
            <input type="text" name="reply" placeholder="–û—Ç–≤–µ—Ç –Ω–∞ –∏–¥–µ—é..." value="{idea["reply"] or ""}" style="width:60%; padding:5px; font-size:14px;">
            <button type="submit" style="padding:5px 10px; font-size:14px;">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
        </form>
        '''
        ideas_html += f'''
        <div class="idea">
            {img}
            <p><strong>{idea["text"]}</strong></p>
            <div class="meta">
                <span>IP: {idea["ip"]}</span>
                <span>üìç {location}</span>
                <span>–ì–æ–ª–æ—Å–æ–≤: {idea["votes"]}</span>
                <a href="/admin/delete/{idea["id"]}?password={password}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                {download_link}
            </div>
            {reply_input}
        </div>
        '''
    return f'''
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ì–æ–ª–æ—Å –∫–ª–∞—Å—Å–∞</title>
        <style>
            * {{ box-sizing: border-box; }}
            body {{ font-family: sans-serif; background: #f9f9f9; padding: 16px; }}
            .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }}
            .idea {{ background: #fef6f6; padding: 15px; margin: 15px 0; border-radius: 8px; }}
            .admin-img {{ max-width: 200px; height: auto; border: 1px solid #eee; margin: 5px 0; }}
            .meta {{ display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; font-size: 13px; }}
            .meta a {{ color: #c0392b; text-decoration: none; }}
            input[type="text"] {{ padding: 5px; font-size: 14px; width: 60%; }}
            button {{ padding: 5px 10px; font-size: 14px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }}
        </style>
    </head>
    <body>
        <div class="container">
            <h2>üîê –ê–¥–º–∏–Ω–∫–∞ (–º–æ–¥–µ—Ä–∞—Ü–∏—è)</h2>
            <p>üìç ‚Äî –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ IP | üíæ ‚Äî —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ | üì® ‚Äî –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—É–±–ª–∏—á–Ω–æ</p>
            {ideas_html}
            <a href="/">‚Üê –ù–∞–∑–∞–¥</a>
        </div>
    </body>
    </html>
    '''

# --- –û—Å—Ç–∞–ª—å–Ω–æ–π HTML (privacy, instructions) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
# (–¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ–ø—É—â–µ–Ω, –Ω–æ –≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –æ–Ω –µ—Å—Ç—å)

def get_privacy_html():
    return '''...'''  # –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏

def get_instructions_html():
    return '''...'''  # –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏

# --- –†–æ—É—Ç—ã ---
@app.route('/')
def index():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    ideas = [dict(row) for row in conn.execute("SELECT id, text, votes, image_data, reply FROM ideas ORDER BY votes DESC, created_at DESC")]
    conn.close()
    return get_index_html(ideas)

@app.route('/add', methods=['POST'])
def add_idea():
    text = request.form.get('text', '').strip()
    if not text or len(text) > 200 or contains_bad_words(text):
        return redirect('/')
    
    user_ip = get_real_ip()
    image_data = process_image(request.files.get('image'))
    
    conn = sqlite3.connect(DB_PATH)
    conn.execute("INSERT INTO ideas (text, ip, image_data) VALUES (?, ?, ?)", (text, user_ip, image_data))
    conn.commit()
    conn.close()
    return redirect('/')

@app.route('/vote/<int:idea_id>')
def vote(idea_id):
    user_ip = get_real_ip()
    conn = sqlite3.connect(DB_PATH)
    exists = conn.execute("SELECT 1 FROM votes WHERE idea_id = ? AND ip = ?", (idea_id, user_ip)).fetchone()
    if not exists:
        conn.execute("UPDATE ideas SET votes = votes + 1 WHERE id = ?", (idea_id,))
        conn.execute("INSERT INTO votes (idea_id, ip) VALUES (?, ?)", (idea_id, user_ip))
        conn.commit()
    conn.close()
    return redirect('/')

@app.route('/admin', methods=['GET', 'POST'])
def admin_panel():
    password = request.args.get('password') or request.form.get('password')
    if password != ADMIN_PASSWORD:
        return redirect('/')
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    ideas = [dict(row) for row in conn.execute("SELECT * FROM ideas ORDER BY created_at DESC")]
    conn.close()
    return get_admin_html(ideas, password)

@app.route('/admin/reply', methods=['POST'])
def admin_reply():
    password = request.form.get('password')
    if password != ADMIN_PASSWORD:
        return redirect('/')
    idea_id = request.form.get('idea_id')
    reply = request.form.get('reply', '').strip()
    if len(reply) > 200:
        reply = reply[:200]
    conn = sqlite3.connect(DB_PATH)
    conn.execute("UPDATE ideas SET reply = ? WHERE id = ?", (reply, idea_id))
    conn.commit()
    conn.close()
    return redirect(f'/admin?password={password}')

@app.route('/admin/delete/<int:idea_id>')
def delete_idea(idea_id):
    password = request.args.get('password')
    if password != ADMIN_PASSWORD:
        return redirect('/')
    conn = sqlite3.connect(DB_PATH)
    conn.execute("DELETE FROM ideas WHERE id = ?", (idea_id,))
    conn.execute("DELETE FROM votes WHERE idea_id = ?", (idea_id,))
    conn.commit()
    conn.close()
    return redirect(f'/admin?password={password}')

@app.route('/download/<int:idea_id>')
def download_image_route(idea_id):
    return download_image(idea_id)

@app.route('/privacy')
def privacy():
    return get_privacy_html()

@app.route('/admin/instructions')
def admin_instructions():
    password = request.args.get('password')
    if password != ADMIN_PASSWORD:
        return redirect('/')
    return get_instructions_html()

# --- –ó–∞–ø—É—Å–∫ ---
if __name__ == '__main__':
    init_db()
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port, debug=False)